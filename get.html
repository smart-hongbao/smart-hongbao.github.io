<html>
<head>
<link rel="icon" href="assets/favicon.svg" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="assets/ethers-5.5.2.umd.min.js" type="application/javascript"></script>
<script src="assets/detect-provider.min.js"></script>
<script src="assets/attention.min.js"></script>
<script src="assets/codec-b64.js"></script>
<link rel="stylesheet" href="assets/attention.css">
<title>ğŸ§§HongBaoğŸ§§</title>
</head>
<body style="background-color:#f14668;">
<div style="margin: 0 auto; width: 380px; position:relative;">
	<div style="position:absolute; top: 0px; left: 0px">
		<img src="assets/favicon.svg" style="width:380px; height: auto">
	</div>
	<p style="position:absolute; width:380px; top: 0px; left: 0px; text-align: center; font-size: 30px; display: none" id="logoP"><a href="#" onclick="return watchAsset();"><img style="width: 60px; height: auto" id="logo" src=""></a></p>
	<p style="position:absolute; width:380px; top: 72px; left: 0px; text-align: center; font-size: 30px; color: gold" id="coins"></p>
	<p style="position:absolute; width:380px; top: 352px; left: 0px; text-align: center; font-size: 30px; color: gold; white-space: pre; word-wrap:break-word; white-space:pre-wrap;" id="words"></p>
	<p style="position:absolute; width:380px; top: 212px; left: 0px; text-align: center; font-size: 30px; display: none; color: white" id="opened"><span data-T>opened//å·²é¢†å–</span></p>
	<p style="position:absolute; width:380px; top: 212px; left: 0px; text-align: center; font-size: 30px; display: none" id="open"><a href="#" onclick="return getHongbao()" style="color: yellow;" data-T>OPEN!//æ‰“å¼€!</a></p>
	<p style="position:absolute; width:380px; top: 174px; left: 0px; text-align: center; font-size: 30px; color: yellow; display: none;" id="sad"><img style="width: 120px; height: auto" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjxzdmcgaGVpZ2h0PSI0OHB4IiBpZD0ic3ZnNDM3NiIgd2lkdGg9IjQ4cHgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6Y2M9Imh0dHA6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL25zIyIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIiB4bWxuczppbmtzY2FwZT0iaHR0cDovL3d3dy5pbmtzY2FwZS5vcmcvbmFtZXNwYWNlcy9pbmtzY2FwZSIgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxuczpzb2RpcG9kaT0iaHR0cDovL3NvZGlwb2RpLnNvdXJjZWZvcmdlLm5ldC9EVEQvc29kaXBvZGktMC5kdGQiIHhtbG5zOnN2Zz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj48ZGVmcyBpZD0iZGVmczMiPjxsaW5lYXJHcmFkaWVudCBpZD0ibGluZWFyR3JhZGllbnQzMjkwIj48c3RvcCBpZD0ic3RvcDMyOTIiIG9mZnNldD0iMC4wMDAwMDAwIiBzdHlsZT0ic3RvcC1jb2xvcjojZmZmY2RlO3N0b3Atb3BhY2l0eToxLjAwMDAwMDA7Ii8+PHN0b3AgaWQ9InN0b3AzMjk0IiBvZmZzZXQ9IjAuNjQ0ODU5NzkiIHN0eWxlPSJzdG9wLWNvbG9yOiNmNmU3NmE7c3RvcC1vcGFjaXR5OjEuMDAwMDAwMDsiLz48c3RvcCBpZD0ic3RvcDMyOTYiIG9mZnNldD0iMS4wMDAwMDAwIiBzdHlsZT0ic3RvcC1jb2xvcjojZmZiNzM4O3N0b3Atb3BhY2l0eToxLjAwMDAwMDA7Ii8+PC9saW5lYXJHcmFkaWVudD48cmFkaWFsR3JhZGllbnQgY3g9IjI5LjI4ODA3MSIgY3k9IjE1LjcyMDk4NCIgZng9IjI5LjE1ODQ2NiIgZnk9IjE1Ljc1NTcxMiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIGlkPSJyYWRpYWxHcmFkaWVudDI3MTQiIHI9IjguOTAyMDc5NiIgeGxpbms6aHJlZj0iI2xpbmVhckdyYWRpZW50MzI5MCIvPjxsaW5lYXJHcmFkaWVudCBpZD0ibGluZWFyR3JhZGllbnQyNTA5Ij48c3RvcCBpZD0ic3RvcDI1MTEiIG9mZnNldD0iMC4wMDAwMDAwIiBzdHlsZT0ic3RvcC1jb2xvcjojZmZmYmQ1O3N0b3Atb3BhY2l0eToxLjAwMDAwMDA7Ii8+PHN0b3AgaWQ9InN0b3AyNTEzIiBvZmZzZXQ9IjEuMDAwMDAwMCIgc3R5bGU9InN0b3AtY29sb3I6I2VkZDQwMDtzdG9wLW9wYWNpdHk6MS4wMDAwMDAwOyIvPjwvbGluZWFyR3JhZGllbnQ+PHJhZGlhbEdyYWRpZW50IGN4PSIyNS4wNTI3IiBjeT0iMzkuNTkyOCIgZng9IjI1LjA1MjciIGZ5PSIzOS41OTI4IiBncmFkaWVudFRyYW5zZm9ybT0ibWF0cml4KDEuMjUwMDAwLDAuMDAwMDAwLDAuMDAwMDAwLC0xLjI1MDAwMCwtNi40Nzk0NDYsNzMuNjY0NDgpIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgaWQ9ImFpZ3JkMiIgcj0iMTUuNzU3MiI+PHN0b3AgaWQ9InN0b3A4NjAyIiBvZmZzZXQ9IjAuMDAwMDAwMCIgc3R5bGU9InN0b3AtY29sb3I6Izc3Nzc3NztzdG9wLW9wYWNpdHk6MS4wMDAwMDAwOyIvPjxzdG9wIGlkPSJzdG9wODYwNCIgb2Zmc2V0PSIxIiBzdHlsZT0ic3RvcC1jb2xvcjojMDAwMDAwIi8+PC9yYWRpYWxHcmFkaWVudD48bGluZWFyR3JhZGllbnQgaWQ9ImxpbmVhckdyYWRpZW50NDU2NSI+PHN0b3AgaWQ9InN0b3A0NTY3IiBvZmZzZXQ9IjAiIHN0eWxlPSJzdG9wLWNvbG9yOiMwMDAwMDA7c3RvcC1vcGFjaXR5OjE7Ii8+PHN0b3AgaWQ9InN0b3A0NTY5IiBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiMwMDAwMDA7c3RvcC1vcGFjaXR5OjA7Ii8+PC9saW5lYXJHcmFkaWVudD48bGluZWFyR3JhZGllbnQgaWQ9ImxpbmVhckdyYWRpZW50MzgyNCI+PHN0b3AgaWQ9InN0b3AzODI2IiBvZmZzZXQ9IjAiIHN0eWxlPSJzdG9wLWNvbG9yOiNmZmZmZmY7c3RvcC1vcGFjaXR5OjE7Ii8+PHN0b3AgaWQ9InN0b3AzODI4IiBvZmZzZXQ9IjEuMDAwMDAwMCIgc3R5bGU9InN0b3AtY29sb3I6I2M5YzljOTtzdG9wLW9wYWNpdHk6MS4wMDAwMDAwOyIvPjwvbGluZWFyR3JhZGllbnQ+PGxpbmVhckdyYWRpZW50IGlkPSJsaW5lYXJHcmFkaWVudDM4MDAiPjxzdG9wIGlkPSJzdG9wMzgwMiIgb2Zmc2V0PSIwLjAwMDAwMDAiIHN0eWxlPSJzdG9wLWNvbG9yOiNmZmVlZDY7c3RvcC1vcGFjaXR5OjEuMDAwMDAwMDsiLz48c3RvcCBpZD0ic3RvcDg2NjQiIG9mZnNldD0iMC41MDAwMDAwMCIgc3R5bGU9InN0b3AtY29sb3I6I2U0OWMyZjtzdG9wLW9wYWNpdHk6MS4wMDAwMDAwOyIvPjxzdG9wIGlkPSJzdG9wMzgwNCIgb2Zmc2V0PSIxLjAwMDAwMDAiIHN0eWxlPSJzdG9wLWNvbG9yOiNmZmM2NmM7c3RvcC1vcGFjaXR5OjEuMDAwMDAwMDsiLz48L2xpbmVhckdyYWRpZW50PjxyYWRpYWxHcmFkaWVudCBjeD0iMjQuNzE0Mjg1IiBjeT0iMzguNTcxNDMwIiBmeD0iMjQuNzE0Mjg1IiBmeT0iMzguNTcxNDMwIiBncmFkaWVudFRyYW5zZm9ybT0ibWF0cml4KDEuMDAwMDAwLDAuMDAwMDAwLDAuMDAwMDAwLDAuMzMzMzMzLDAuMDAwMDAwLDI1LjcxNDI5KSIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIGlkPSJyYWRpYWxHcmFkaWVudDQ1NzEiIHI9IjE5LjcxNDI4NSIgeGxpbms6aHJlZj0iI2xpbmVhckdyYWRpZW50NDU2NSIvPjwvZGVmcz48ZyBpZD0ibGF5ZXIxIj48cGF0aCBkPSJNIDQ0LjQyODU3MCAzOC41NzE0MzAgQSAxOS43MTQyODUgNi41NzE0Mjg4IDAgMSAxICA1LjAwMDAwMDAsMzguNTcxNDMwIEEgMTkuNzE0Mjg1IDYuNTcxNDI4OCAwIDEgMSAgNDQuNDI4NTcwIDM4LjU3MTQzMCB6IiBpZD0icGF0aDQ1NjMiIHN0eWxlPSJvcGFjaXR5OjAuNTMxNjQ1NTc7Y29sb3I6IzAwMDAwMDtmaWxsOnVybCgjcmFkaWFsR3JhZGllbnQ0NTcxKTtmaWxsLW9wYWNpdHk6MS4wO2ZpbGwtcnVsZTpldmVub2RkO3N0cm9rZTpub25lO3N0cm9rZS13aWR0aDowLjQwNDg3MTczO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1saW5lam9pbjpyb3VuZDttYXJrZXI6bm9uZTttYXJrZXItc3RhcnQ6bm9uZTttYXJrZXItbWlkOm5vbmU7bWFya2VyLWVuZDpub25lO3N0cm9rZS1taXRlcmxpbWl0OjQuMDAwMDAwMDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLWRhc2hvZmZzZXQ6MC4wMDAwMDAwO3N0cm9rZS1vcGFjaXR5OjEuMDAwMDAwMDt2aXNpYmlsaXR5OnZpc2libGU7ZGlzcGxheTppbmxpbmU7b3ZlcmZsb3c6dmlzaWJsZSIvPjxwYXRoIGQ9Ik0gMzkuNzc0NzU1IDE5LjAwODYyMSBBIDguNjYyMDU3OSA4LjY2MjA1NzkgMCAxIDEgIDIyLjQ1MDY0MCwxOS4wMDg2MjEgQSA4LjY2MjA1NzkgOC42NjIwNTc5IDAgMSAxICAzOS43NzQ3NTUgMTkuMDA4NjIxIHoiIGlkPSJwYXRoNDMyMCIgc3R5bGU9Im9wYWNpdHk6MS4wMDAwMDAwO2NvbG9yOiMwMDAwMDA7ZmlsbDp1cmwoI3JhZGlhbEdyYWRpZW50MjcxNCk7ZmlsbC1vcGFjaXR5OjEuMDAwMDAwMDtmaWxsLXJ1bGU6ZXZlbm9kZDtzdHJva2U6IzljOGMwYTtzdHJva2Utd2lkdGg6MC40ODAwNDQwNDtzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46cm91bmQ7bWFya2VyOm5vbmU7bWFya2VyLXN0YXJ0Om5vbmU7bWFya2VyLW1pZDpub25lO21hcmtlci1lbmQ6bm9uZTtzdHJva2UtbWl0ZXJsaW1pdDo0LjAwMDAwMDA7c3Ryb2tlLWRhc2hhcnJheTpub25lO3N0cm9rZS1kYXNob2Zmc2V0OjAuMDAwMDAwMDtzdHJva2Utb3BhY2l0eToxLjAwMDAwMDA7dmlzaWJpbGl0eTp2aXNpYmxlO2Rpc3BsYXk6aW5saW5lO292ZXJmbG93OnZpc2libGUiIHRyYW5zZm9ybT0ibWF0cml4KDIuMDgzMTQyLDAuMDAwMDAwLDAuMDAwMDAwLDIuMDgzMTQyLC00MC41NDcxNSwtMTYuNDkyMjQpIi8+PHBhdGggZD0iTSAzOS43NzQ3NTUgMTkuMDA4NjIxIEEgOC42NjIwNTc5IDguNjYyMDU3OSAwIDEgMSAgMjIuNDUwNjQwLDE5LjAwODYyMSBBIDguNjYyMDU3OSA4LjY2MjA1NzkgMCAxIDEgIDM5Ljc3NDc1NSAxOS4wMDg2MjEgeiIgaWQ9InBhdGg0MzIyIiBzdHlsZT0ib3BhY2l0eTowLjY3NzIxNTE5O2NvbG9yOiMwMDAwMDA7ZmlsbDpub25lO2ZpbGwtb3BhY2l0eToxLjAwMDAwMDA7ZmlsbC1ydWxlOmV2ZW5vZGQ7c3Ryb2tlOiNmZmZmZmY7c3Ryb2tlLXdpZHRoOjAuNTA1MTA2Mjc7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO21hcmtlcjpub25lO21hcmtlci1zdGFydDpub25lO21hcmtlci1taWQ6bm9uZTttYXJrZXItZW5kOm5vbmU7c3Ryb2tlLW1pdGVybGltaXQ6NC4wMDAwMDAwO3N0cm9rZS1kYXNoYXJyYXk6bm9uZTtzdHJva2UtZGFzaG9mZnNldDowLjAwMDAwMDA7c3Ryb2tlLW9wYWNpdHk6MS4wMDAwMDAwO3Zpc2liaWxpdHk6dmlzaWJsZTtkaXNwbGF5OmlubGluZTtvdmVyZmxvdzp2aXNpYmxlIiB0cmFuc2Zvcm09Im1hdHJpeCgxLjk3OTc4MiwwLjAwMDAwMCwwLjAwMDAwMCwxLjk3OTc4MiwtMzcuMzMxMjgsLTE0LjUyNzQ2KSIvPjxwYXRoIGQ9Ik0gMzQuMDE0MjY4LDMyLjAzNjg0MiBDIDMwLjI5MDY5NCwyNy44NzI4MzAgMjguNDUxODU5LDI2LjQwNTU2MSAyNC40NjI0OTIsMjYuNDA1NTYxIEMgMjAuNTYxMzEzLDI2LjQwNTU2MSAxNy45NjI4MjAsMjguMDkzNjA3IDE1LjA4NzQ5MiwzMi4zOTAzOTYgQyAxOC41MjA3ODksMzAuMDQxNTgzIDIwLjM5NzEyNCwyOC43NDA5MDAgMjQuMTk3MzI3LDI4Ljc0MDkwMCBDIDI3LjkwOTE2NiwyOC43NDA5MDAgMjkuOTQ4NDA0LDI5Ljc5MTU5OSAzNC4wMTQyNjgsMzIuMDM2ODQyIHogIiBpZD0icGF0aDEzODciIHN0eWxlPSJvdmVyZmxvdzp2aXNpYmxlO2Rpc3BsYXk6aW5saW5lO3Zpc2liaWxpdHk6dmlzaWJsZTtzdHJva2Utb3BhY2l0eToxLjAwMDAwMDA7c3Ryb2tlLWRhc2hvZmZzZXQ6MC4wMDAwMDAwO3N0cm9rZS1kYXNoYXJyYXk6bm9uZTttYXJrZXItZW5kOm5vbmU7bWFya2VyLW1pZDpub25lO21hcmtlci1zdGFydDpub25lO21hcmtlcjpub25lO3N0cm9rZS1saW5lam9pbjptaXRlcjtzdHJva2UtbGluZWNhcDpidXR0O3N0cm9rZS13aWR0aDoxLjAwMDAwMDA7ZmlsbC1vcGFjaXR5OjEuMDAwMDAwMDtjb2xvcjojMDAwMDAwO29wYWNpdHk6MC4zNTk5OTk5ODtzdHJva2UtbWl0ZXJsaW1pdDo0LjAwMDAwMDA7c3Ryb2tlOm5vbmU7ZmlsbC1ydWxlOm5vbnplcm87ZmlsbDojZmZmZmZmIi8+PHBhdGggZD0iTSAzNC4wMTQyNjgsMzEuMzI5NzM4IEMgMzAuMjkwNjk0LDI3LjE2NTcyNiAyOC40NTE4NTksMjUuNjk4NDU3IDI0LjQ2MjQ5MiwyNS42OTg0NTcgQyAyMC41NjEzMTMsMjUuNjk4NDU3IDE3Ljk2MjgyMCwyNy4zODY1MDMgMTUuMDg3NDkyLDMxLjY4MzI5MiBDIDE4LjUyMDc4OSwyOS4zMzQ0NzkgMjAuMzk3MTI0LDI4LjAzMzc5NiAyNC4xOTczMjcsMjguMDMzNzk2IEMgMjcuOTA5MTY2LDI4LjAzMzc5NiAyOS45NDg0MDQsMjkuMDg0NDk1IDM0LjAxNDI2OCwzMS4zMjk3MzggeiAiIGlkPSJwYXRoODYwNiIgc3R5bGU9ImZpbGw6dXJsKCNhaWdyZDIpO2ZpbGwtcnVsZTpub256ZXJvO3N0cm9rZTpub25lO3N0cm9rZS1taXRlcmxpbWl0OjQuMDAwMDAwMCIvPjxnIGlkPSJnODY2NiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMC4zNTM1NTMsMi4zOTI3MDYpIj48cGF0aCBkPSJNIDIxLjM5ODE1OCwxNS4zMjE0MjggQyAyMS4zOTgxNTgsMTcuODIxNDI4IDIwLjI3MzE1OCwxOS44MjE0MjggMTguODk4MTU4LDE5LjgyMTQyOCBDIDE3LjUyMzE1OCwxOS44MjE0MjggMTYuMjczMTU4LDE3LjgyMTQyOCAxNi4yNzMxNTgsMTUuMzIxNDI4IEMgMTYuMjczMTU4LDEyLjgyMTQyOCAxNy4zOTgxNTgsMTAuODIxNDI4IDE4Ljc3MzE1OCwxMC44MjE0MjggQyAyMC4xNDgxNTgsMTAuODIxNDI4IDIxLjI3MzE1OCwxMi44MjE0MjggMjEuMjczMTU4LDE1LjMyMTQyOCBMIDIxLjM5ODE1OCwxNS4zMjE0MjggeiAiIGlkPSJwYXRoODYxMCIgc3R5bGU9Im9wYWNpdHk6MC4zNTk5OTk5ODtmaWxsOiNmZmZmZmY7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmU7c3Ryb2tlLW1pdGVybGltaXQ6NC4wMDAwMDAwIi8+PHBhdGggZD0iTSAzMC42ODg1MTIsMTUuMzIxNDI4IEMgMzAuNjg4NTEyLDE3LjgyMTQyOCAyOS41NjM1MTIsMTkuODIxNDI4IDI4LjE4ODUxMiwxOS44MjE0MjggQyAyNi44MTM1MTIsMTkuODIxNDI4IDI1LjY4ODUxMiwxNy44MjE0MjggMjUuNjg4NTEyLDE1LjMyMTQyOCBDIDI1LjY4ODUxMiwxMi44MjE0MjggMjYuODEzNTEyLDEwLjgyMTQyOCAyOC4xODg1MTIsMTAuODIxNDI4IEMgMjkuNTYzNTEyLDEwLjgyMTQyOCAzMC42ODg1MTIsMTIuODIxNDI4IDMwLjY4ODUxMiwxNS4zMjE0MjggeiAiIGlkPSJwYXRoODYxMiIgc3R5bGU9Im9wYWNpdHk6MC4zNTk5OTk5ODtmaWxsOiNmZmZmZmY7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmU7c3Ryb2tlLW1pdGVybGltaXQ6NC4wMDAwMDAwIi8+PHBhdGggZD0iTSAyMS4zOTgxNTgsMTQuNjk2NDI4IEMgMjEuMzk4MTU4LDE3LjE5NjQyOCAyMC4yNzMxNTgsMTkuMTk2NDI4IDE4Ljg5ODE1OCwxOS4xOTY0MjggQyAxNy41MjMxNTgsMTkuMTk2NDI4IDE2LjM5ODE1OCwxNy4xOTY0MjggMTYuMzk4MTU4LDE0LjY5NjQyOCBDIDE2LjM5ODE1OCwxMi4xOTY0MjggMTcuNTIzMTU4LDEwLjE5NjQyOCAxOC44OTgxNTgsMTAuMTk2NDI4IEMgMjAuMjczMTU4LDEwLjE5NjQyOCAyMS4zOTgxNTgsMTIuMTk2NDI4IDIxLjM5ODE1OCwxNC42OTY0MjggeiAiIGlkPSJwYXRoODYxNCIgc3R5bGU9ImZpbGw6IzAwMDAwMDtmaWxsLXJ1bGU6bm9uemVybztzdHJva2U6bm9uZTtzdHJva2UtbWl0ZXJsaW1pdDo0LjAwMDAwMDAiLz48cGF0aCBkPSJNIDMwLjY4ODUxMiwxNC42OTY0MjggQyAzMC42ODg1MTIsMTcuMTk2NDI4IDI5LjU2MzUxMiwxOS4xOTY0MjggMjguMTg4NTEyLDE5LjE5NjQyOCBDIDI2LjgxMzUxMiwxOS4xOTY0MjggMjUuNjg4NTEyLDE3LjE5NjQyOCAyNS42ODg1MTIsMTQuNjk2NDI4IEMgMjUuNjg4NTEyLDEyLjE5NjQyOCAyNi44MTM1MTIsMTAuMTk2NDI4IDI4LjE4ODUxMiwxMC4xOTY0MjggQyAyOS41NjM1MTIsMTAuMTk2NDI4IDMwLjY4ODUxMiwxMi4xOTY0MjggMzAuNjg4NTEyLDE0LjY5NjQyOCB6ICIgaWQ9InBhdGg4NjE2IiBzdHlsZT0iZmlsbDojMDAwMDAwO2ZpbGwtcnVsZTpub256ZXJvO3N0cm9rZTpub25lO3N0cm9rZS1taXRlcmxpbWl0OjQuMDAwMDAwMCIvPjwvZz48L2c+PC9zdmc+"></p>
</div>

<script>

// ver8,coinType160,amount96,dueTime80,makerAddr160,r256,s256,v8,otherWords
const CoinTypeStart =  1
const AmountStart =    1+20
const DueTimeStart =   1+20+12
const MakerAddrStart = 1+20+12+10
const SigRStart =      1+20+12+10+20
const SigSStart =      1+20+12+10+20+32
const SigVStart =      1+20+12+10+20+32+32
const WordsStart =     1+20+12+10+20+32+32+1

const SEP20ABI = [
    "function symbol() view returns (string)",
    "function decimals() view returns (uint8)",
    "function balanceOf(address account) external view returns (uint256)",
    "function approve(address spender, uint256 amount) external returns (bool)",
]

const ExHubAddress = "0x88D12E0369923dBf3b7c830c52ca67C1B0a56f0A"

const ExHubABI = [
"function exchangeWithAgentSig(uint256 coinsToMaker, uint256 coinsToTaker, uint256 takerAddr_dueTime80_v8, address makerAddr, bytes32 r, bytes32 s) payable external",
"function isReplay(address makerAddr, uint dueTime) external view returns (bool)",
"function makerNextRecentDueTime(address maker, uint dueTime) external view returns (uint)",
"function makerRDTHeadTail(address maker) external view returns (uint)",
]

const Symbol2Addr = {
	EBEN: "0x77CB87b57F54667978Eb1B199b28a0db8C8E1c0B",
	FLEXUSD: "0x7b2B3C5308ab5b2a1d9a94d20D35CCDf61e05b72",
	MIST: "0x5fA664f69c2A4A3ec94FaC3cBf7049BD9CA73129",
	LAW: "0x0b00366fBF7037E9d75E4A569ab27dAB84759302",
	TANGO: "0x73BE9c8Edf5e951c9a0762EA2b1DE8c8F38B5e91",
	"$CATS": "0x265bD28d79400D55a1665707Fa14A72978FA6043",
	DAIQUIRI: "0x24d8d5Cbc14FA6A740c3375733f0287188F8dF3b",
	CLY: "0x7642Df81b5BEAeEb331cc5A104bd13Ba68c34B91",
	BPAD: "0x9192940099fDB2338B928DE2cad9Cd1525fEa881",
	JOY: "0x6732E55Ac3ECa734F54C26Bd8DF4eED52Fb79a6E",
	BURN: "0xc07545D17e716CF7FF24ed0eb16A69157A33aaCd",
	FLEX: "0x98Dd7eC28FB43b3C4c770AE532417015fa939Dd3",
	CLK: "0x659F04F36e90143fCaC202D4BC36C699C078fC98",
	ORB: "0xff3ed63bf8bc9303ea0a7e1215ba2f82d569799e",
	SPICE: "0xe11829a7d5d8806bb36e118461a1012588fafd89",
	DAO: "0xca0235058985fcc1839e9e37c10900a73c126708",
	ARG: "0x675E1d6FcE8C7cC091aED06A68D079489450338a",
	MILK: "0xc8E09AEdB3c949a875e1FD571dC4b3E48FB221f0",
}

function IsPC() {
       var userAgentInfo = navigator.userAgent;
       var Agents = new Array("Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod");
       var flag = true;
       for (var v = 0; v < Agents.length; v++) {
            if (userAgentInfo.indexOf(Agents[v]) > 0) {
                flag = false;
                break;
             }
       }
       return flag;
}

async function connect() {
	if (typeof window.ethereum === 'undefined') {
		if (typeof window.web3 !== 'undefined') {
			window.ethereum = window.web3;
		} else if (typeof window.TPJSBrigeClient !== 'undefined') {
			window.ethereum = window.TPJSBrigeClient;
		} else if (typeof window.imToken !== 'undefined') {
			window.ethereum = window.imToken;
		} else {
			const provider = await detectEthereumProvider();
			if (provider) {
				window.ethereum = provider;
			} else {
				var c = T("Please open this page inside a mobile wallet App.//è¯·ä½¿ç”¨é’±åŒ…APPå†…ç½®æµè§ˆå™¨æ‰“å¼€æœ¬é¡µé¢ã€‚")
				if(IsPC()) {
					c = T("Your browser has not installed a wallet extension (like MetaMask).//æ‚¨çš„æµè§ˆå™¨å°šæœªå®‰è£…é’±åŒ…æ‰©å±•ï¼ˆä¾‹å¦‚MetaMaskï¼‰")
				}
				window.AlertDlg = new Attention.Alert({title: T("Warning//è­¦å‘Š"), content: c});
				return false;
			}
		}
	}
	window.accounts = await window.ethereum.request({method: 'eth_requestAccounts'});
	if (window.accounts.length == 0) {
        	window.AlertDlg = new Attention.Alert({title: T("Warning//è­¦å‘Š"),
        	  content: T("Cannot connect to wallet//æ— æ³•è¿æ¥é’±åŒ…")});
		return false;
	}
	return true;
}

function timestamp2string(timestamp) {
  var t = new Date()
  t.setTime(timestamp)
  var s = t.toLocaleString("en-US", {hour12: false})
  return s.slice(0, s.length-3)
}

function T(text) {
	try {
		const twoStr = text.split("//");
		if (window.LANG === "cn") {
		    return twoStr[1];
		}
		return twoStr[0];
	} catch (e) {
		return text;
	}
}

async function init() {
	const url = new URL(location.href);

	window.LANG = "en";
	console.log(window.location.href);
	if(url.searchParams.get("lang") == "cn") {
		window.LANG = "cn";
	} else if (url.searchParams.get("lang") == "en") {
		window.LANG = "en";
	} else if (navigator.language.startsWith("zh")) {
		window.LANG = "cn";
	}

	connect()

	var elems = document.querySelectorAll('*[data-T]');
	for (var i = 0; i < elems.length; i++) {
		elems[i].innerText = T(elems[i].innerText);
	}

	const user = url.searchParams.get("u");
	const content = url.searchParams.get("c");
	if(content) {
		initUI(user, content)
		return
	}
	const srcURL = url.searchParams.get("s");
	if(!srcURL) {return;}
	const provider = new ethers.providers.Web3Provider(window.ethereum);
	const signer = provider.getSigner();
	const myAddr = await signer.getAddress();
	window.SrcURL = decodeURIComponent(srcURL)
	var timer = setTimeout(() => {
        	window.AlertDlg = new Attention.Alert({title: T("Connection Timeout//è¿æ¥è¶…æ—¶"),
        	  content: T("Cannot connect to //æ— æ³•è¿æ¥åˆ°")+window.SrcURL});
	}, 10*1000);
	document.getElementById("srcIframe").src = window.SrcURL+"?msg=1"
	window.addEventListener('message', function(event) {
		if(event.data.event_id && event.data.event_id == "hongbao_cors_message") {
			clearTimeout(timer)
			var content = event.data.hb_map[myAddr]
			if(!content) {
				window.ERR = {title: T("Warning//è­¦å‘Š"),
				  content: T(`Your accout ${myAddr} is not in the list of receivers//ä½ çš„åœ°å€${myAddr} ä¸åœ¨çº¢åŒ…çš„æ¥æ”¶è€…åˆ—è¡¨ä¸­`)}
				window.AlertDlg = new Attention.Alert(window.ERR);
				return
			}
			initUI(myAddr, content)
		}
	});
}

async function initUI(user, content) {
	const u8arr = base64DecToArr(content);
	//console.log("content.length", content.length)
	//console.log("content", content)
	//console.log("u8arr", u8arr)
	const words = UTF8ArrToStr(u8arr.slice(WordsStart))
	document.getElementById("words").innerText = words

	var hongbao={}
	hongbao.coinType = ethers.utils.getAddress(ethers.utils.hexlify(u8arr.slice(CoinTypeStart, AmountStart)))
	hongbao.amount = ethers.BigNumber.from(ethers.utils.hexlify(u8arr.slice(AmountStart, DueTimeStart)))
	hongbao.dueTime = ethers.BigNumber.from(ethers.utils.hexlify(u8arr.slice(DueTimeStart, MakerAddrStart)))
	hongbao.maker = ethers.utils.getAddress(ethers.utils.hexlify(u8arr.slice(MakerAddrStart, SigRStart)))
	hongbao.r = ethers.utils.hexlify(u8arr.slice(SigRStart, SigSStart))
	hongbao.s = ethers.utils.hexlify(u8arr.slice(SigSStart, SigVStart))
	hongbao.v = ethers.BigNumber.from(ethers.utils.hexlify(u8arr.slice(SigVStart, WordsStart)))
	//console.log("coinType", hongbao.coinType)
	//console.log("amount", hongbao.amount.toHexString())
	//console.log("dueTime", hongbao.dueTime.toHexString())
	//console.log("maker", hongbao.maker)
	//console.log("rs", hongbao.r, hongbao.s)
	const url = new URL(location.href);
	var decimals = url.searchParams.get("d");
	var symbol = url.searchParams.get("sym");
	if(decimals && symbol) {
		var amt = ethers.utils.formatUnits(hongbao.amount, decimals)*1.0
		document.getElementById("coins").innerText = amt+" "+symbol
	}

	const provider = new ethers.providers.Web3Provider(window.ethereum);
	const signer = provider.getSigner();
	const myAddr = await signer.getAddress();
	const network = await provider.getNetwork();
	if(network.chainId != 10000) {
		new Attention.Confirm({title: T("Incorrect Network//é”™è¯¯çš„é“¾"),
			content: T("You are not connecting to the smartBCH chain. Do you want to add smartBCH?//æ‚¨è¿æ¥çš„å¹¶æœªsmartBCHé“¾ï¼Œè¯·å°†smartBCHåŠ å…¥æ‚¨çš„é’±åŒ…ã€‚"),
			onConfirm(component) {
				addSmartBCH()
			},
			onCancel(component) {}});
		return
	}
	if(user && user != myAddr) {
		window.ERR = {title: T("Warning//è­¦å‘Š"),
		  content: T("This URL is not a hongbao for you//æ­¤ç½‘å€å¹¶éç»™æ‚¨å‘é€çš„çº¢åŒ…")}
        	window.AlertDlg = new Attention.Alert(window.ERR);
		return;
	}

	hongbao.takerAddr = myAddr
	if(!user) {
		hongbao.takerAddr = "0x0"
	}

	const sep20Contract = new ethers.Contract(hongbao.coinType, SEP20ABI, provider)
	try {
		symbol = await sep20Contract.symbol()
		decimals = await sep20Contract.decimals()
	} catch(e) {
		window.ERR = {title: T("Warning//è­¦å‘Š"),
		  content: T("Cannot access RPC server//æ— æ³•è®¿é—®RPCæœåŠ¡å™¨")}
        	window.AlertDlg = new Attention.Alert(window.ERR);
		return;
	}
	hongbao.symbol = symbol
	hongbao.decimals = decimals
	amt = ethers.utils.formatUnits(hongbao.amount, decimals)*1.0
	document.getElementById("coins").innerText = amt+" "+symbol
	if(Symbol2Addr[symbol] == hongbao.coinType) {
		document.getElementById("logoP").style.display = "block"
		document.getElementById("logo").src = "/logo/"+symbol+".png"
	}

	const balanceAmt = await sep20Contract.balanceOf(hongbao.maker)
	if(balanceAmt.lt(hongbao.amount)) {
		window.ERR = {title: T("Sender's balance is not enough//å‘é€è€…ä½™é¢ä¸è¶³"),
        	  content: T("Sender's balance has been used up by other receivers and can't pay your hongbao now.//å‘é€è€…çš„ä½™é¢å·²ç»è¢«å…¶ä»–æ¥æ”¶è€…æ”¯å–ä¸€ç©ºï¼Œæ— æ³•å†æ”¯ä»˜æ‚¨çš„çº¢åŒ…")};
        	window.AlertDlg = new Attention.Alert(window.ERR);
		document.getElementById("sad").style.display = "block"
		return false;
	}
	
	const dueTime = hongbao.dueTime.div(1000*1000*1000).toNumber() //picoseconds to microseconds
	if(dueTime < Date.now()) {
		window.ERR = {title: T("Hongbao Expired//çº¢åŒ…è¿‡æœŸ"),
        	  content: T("Sorry, but this hongbao was expired at //æŠ±æ­‰ï¼Œæ­¤çº¢åŒ…å·²äºæ­¤æ—¶åˆ»è¿‡æœŸï¼š")+timestamp2string(dueTime)};
        	window.AlertDlg = new Attention.Alert(window.ERR);
		document.getElementById("sad").style.display = "block"
		return false;
	}

	const exhubContract = new ethers.Contract(ExHubAddress, ExHubABI, provider);
	var alreadyAccepted = await exhubContract.isReplay(hongbao.maker, hongbao.dueTime);
	//console.log("alreadyAccepted", alreadyAccepted);
	//console.log("dueTime", hongbao.dueTime);
	//const a = await exhubContract.makerNextRecentDueTime(hongbao.maker, hongbao.dueTime);
	//console.log("a", a);
	//const b = await exhubContract.makerRDTHeadTail(hongbao.maker);
	//console.log("b", b);
	if(alreadyAccepted) {
		window.ERR = {title: T("Already Accepted//çº¢åŒ…å·²è¢«æ¥æ”¶"),
        	  content: T("Sorry, but this hongbao has been accepted before//æŠ±æ­‰ï¼Œæ­¤çº¢åŒ…å·²ç»è¢«é¢†èµ°")}
        	window.AlertDlg = new Attention.Alert(window.ERR);
		document.getElementById("sad").style.display = "block"
		return false;
	}

	window.HB = hongbao
	document.getElementById("open").style.display = "block"
}

function addSmartBCH() {
	window.ethereum.request({
	  method: 'wallet_addEthereumChain',
	  params: [{
	    "chainId": "0x2710",
	    "chainName": "smartBCH",
	    "rpcUrls": ["https://smartbch.fountainhead.cash/mainnet"],
	    "nativeCurrency": {
	      "name": "smart BCH",
	      "symbol": "BCH",
	      "decimals": 18
	    },
	    "blockExplorerUrls": ["https://www.smartscan.cash"]
	  }],
	});
}

async function recheckBalance() {
	const provider = new ethers.providers.Web3Provider(window.ethereum);
	const signer = provider.getSigner();
	const myAddr = await signer.getAddress();
	const sep20Contract = new ethers.Contract(HB.coinType, SEP20ABI, provider)
	const balanceAmt = await sep20Contract.balanceOf(HB.maker)
	if(balanceAmt.lt(HB.amount)) {
		window.ERR = {title: T("Sender's balance is not enough//å‘é€è€…ä½™é¢ä¸è¶³"),
        	  content: T("Sender's balance has been used up by other receivers and can't pay your hongbao now.//å‘é€è€…çš„ä½™é¢å·²ç»è¢«å…¶ä»–æ¥æ”¶è€…æ”¯å–ä¸€ç©ºï¼Œæ— æ³•å†æ”¯ä»˜æ‚¨çš„çº¢åŒ…")};
        	window.AlertDlg = new Attention.Alert(window.ERR);
		document.getElementById("open").style.display = "none"
		document.getElementById("sad").style.display = "block"
		return false;
	}
}

function watchAsset() {
	ethereum.request({
	  method: 'wallet_watchAsset',
	  params: {
	    type: 'ERC20',
	    options: {
	      address: HB.coinType,
	      symbol: HB.symbol,
	      decimals: HB.decimals,
	      img: "https://hongbao.click/logo/"+HB.symbol+".png",
	    },
	  },
	});
	return false;
}

async function getHongbao() {
	if(window.ERR) {
        	window.AlertDlg = new Attention.Alert(window.ERR);
		return false;
	}
	if(!window.HB) {
		return false;
	}
	recheckBalance()
	const provider = new ethers.providers.Web3Provider(window.ethereum);
	const signer = provider.getSigner();
	const exhubContract = new ethers.Contract(ExHubAddress, ExHubABI, provider).connect(signer);

	const twoPow80 = ethers.BigNumber.from(2).pow(80);
	const twoPow96 = ethers.BigNumber.from(2).pow(96);
	var coinsToTaker = ethers.BigNumber.from(HB.coinType).mul(twoPow96).add(HB.amount)
	var takerAddr_dueTime80_v8 = ethers.BigNumber.from(HB.takerAddr).mul(twoPow80).add(HB.dueTime)
	takerAddr_dueTime80_v8 = takerAddr_dueTime80_v8.mul(256).add(HB.v)
	const tx = await exhubContract.exchangeWithAgentSig("0x0", coinsToTaker, takerAddr_dueTime80_v8, HB.maker, HB.r, HB.s);
	const receipt = await tx.wait();
	console.log(receipt);
	document.getElementById("open").style.display = "none"
	document.getElementById("opened").style.display = "block"
	return false;
}

window.onload = init;

document.onclick = function() {
	if(window.AlertDlg) window.AlertDlg.destroy();
}

</script>
<iframe id="srcIframe" src="" style="display: none" hidden></iframe>
</body>
</html>
