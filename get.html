<html>
<head>
<link rel="icon" href="assets/favicon.svg" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="assets/ethers-5.5.2.umd.min.js" type="application/javascript"></script>
<script src="assets/detect-provider.min.js"></script>
<script src="assets/attention.js"></script>
<script src="assets/codec-b64.js"></script>
<link rel="stylesheet" href="assets/attention.css">
<title>ðŸ§§HongBaoðŸ§§</title>
</head>
<body style="background-color:#f14668;">
<div style="margin: 0 auto; width: 380px; position:relative;">
	<div style="position:absolute; top: 0px; left: 0px">
	<a href="#" onclick="return getHongbao()">
			<img src="assets/favicon.svg" style="width:380px; height: auto">
		<!--
		-->
	</a></div>
	<p style="position:absolute; width:380px; top: 68px; left: 0px; text-align: center; font-size: 30px; color: gold" id="coins"></p>
	<p style="position:absolute; width:380px; top: 352px; left: 0px; text-align: center; font-size: 30px; color: gold; white-space: pre;" id="words"></p>
</div>

<script>

// ver8,coinType160,amount96,dueTime80,makerAddr160,r256,s256,v8,otherWords
const CoinTypeStart =  1
const AmountStart =    1+20
const DueTimeStart =   1+20+12
const MakerAddrStart = 1+20+12+10
const SigRStart =      1+20+12+10+20
const SigSStart =      1+20+12+10+20+32
const SigVStart =      1+20+12+10+20+32+32
const WordsStart =     1+20+12+10+20+32+32+1

const SEP20ABI = [
    "function symbol() view returns (string)",
    "function decimals() view returns (uint8)",
    "function balanceOf(address account) external view returns (uint256)",
    "function approve(address spender, uint256 amount) external returns (bool)",
]

const ExHubAddress = "0x88D12E0369923dBf3b7c830c52ca67C1B0a56f0A"

const ExHubABI = [
"function exchangeWithAgentSig(uint256 coinsToMaker, uint256 coinsToTaker, uint256 takerAddr_dueTime80_v8, address makerAddr, bytes32 r, bytes32 s) payable external",
"function isReplay(address makerAddr, uint dueTime) external view returns (bool)",
"function makerNextRecentDueTime(address maker, uint dueTime) external view returns (uint)",
"function makerRDTHeadTail(address maker) external view returns (uint)",
]


async function connect() {
	if (typeof window.ethereum === 'undefined') {
		if (typeof window.web3 !== 'undefined') {
			window.ethereum = window.web3;
		} else if (typeof window.TPJSBrigeClient !== 'undefined') {
			window.ethereum = window.TPJSBrigeClient;
		} else if (typeof window.imToken !== 'undefined') {
			window.ethereum = window.imToken;
		} else {
			const provider = await detectEthereumProvider();
			if (provider) {
				window.ethereum = provider;
			} else if(IsPC()) {
				alert("Your browser has not installed a wallet extension (like MetaMask).");
			} else {
				alert("Please open this page inside a mobile wallet App.");
			}
		}
	}
	window.accounts = await window.ethereum.request({method: 'eth_requestAccounts'});
	if (window.accounts.length == 0) {
        	window.AlertDlg = new Attention.Alert({title: "Warning",
        	  content: "Cannot connect to wallet"});
		return false;
	}
	return true;
}

function timestamp2string(timestamp) {
  var t = new Date()
  t.setTime(timestamp)
  var s = t.toLocaleString("en-US", {hour12: false})
  return s.slice(0, s.length-3)
}

async function init() {
	if(!connect()) {return;}

	const url = new URL(location.href);
	const user = url.searchParams.get("u");
	const content = url.searchParams.get("c");
	if(user && content) {
		initUI(user, content)
		return
	}
	const srcURL = url.searchParams.get("s");
	if(!srcURL) {return;}
	const provider = new ethers.providers.Web3Provider(window.ethereum);
	const signer = provider.getSigner();
	const myAddr = await signer.getAddress();
	document.getElementById("srcIframe").src = decodeURIComponent(srcURL)+"?msg=1"
	window.addEventListener('message', function(event) {
		if(event.data.event_id && event.data.event_id == "hongbao_cors_message") {
			initUI(myAddr, event.data.hb_map[myAddr])
		}
	});
}

async function initUI(user, content) {
	if(!content) {
		window.ERR = {title: "Warning",
		  content: `Cannot find any hongbao for your accout ${myAddr}`}
        	window.AlertDlg = new Attention.Alert(window.ERR);
		return
	}
	const provider = new ethers.providers.Web3Provider(window.ethereum);
	const signer = provider.getSigner();
	const myAddr = await signer.getAddress();
	if(user != myAddr) {
		window.ERR = {title: "Warning",
		  content: `This hongbao is for ${user}, not your accout ${myAddr}`}
        	window.AlertDlg = new Attention.Alert(window.ERR);
		return;
	}
	const u8arr = base64DecToArr(content);
	//console.log("content.length", content.length)
	//console.log("content", content)
	//console.log("u8arr", u8arr)
	const words = UTF8ArrToStr(u8arr.slice(WordsStart))
	document.getElementById("words").innerText = words

	var hongbao={}
	hongbao.coinType = ethers.utils.getAddress(ethers.utils.hexlify(u8arr.slice(CoinTypeStart, AmountStart)))
	hongbao.amount = ethers.BigNumber.from(ethers.utils.hexlify(u8arr.slice(AmountStart, DueTimeStart)))
	hongbao.dueTime = ethers.BigNumber.from(ethers.utils.hexlify(u8arr.slice(DueTimeStart, MakerAddrStart)))
	hongbao.maker = ethers.utils.getAddress(ethers.utils.hexlify(u8arr.slice(MakerAddrStart, SigRStart)))
	hongbao.r = ethers.BigNumber.from(ethers.utils.hexlify(u8arr.slice(SigRStart, SigSStart))).toHexString()
	hongbao.s = ethers.BigNumber.from(ethers.utils.hexlify(u8arr.slice(SigSStart, SigVStart))).toHexString()
	hongbao.v = ethers.BigNumber.from(ethers.utils.hexlify(u8arr.slice(SigVStart, WordsStart)))
	//console.log("coinType", hongbao.coinType)
	//console.log("amount", hongbao.amount.toHexString())
	//console.log("dueTime", hongbao.dueTime.toHexString())
	//console.log("maker", hongbao.maker)
	//console.log("rs", hongbao.r, hongbao.s)

	const sep20Contract = new ethers.Contract(hongbao.coinType, SEP20ABI, provider)
	const symbol = await sep20Contract.symbol()
	const decimals = await sep20Contract.decimals()
	const amt = ethers.utils.formatUnits(hongbao.amount, decimals)
	document.getElementById("coins").innerText = amt+" "+symbol
	
	const dueTime = hongbao.dueTime.div(1000*1000*1000).toNumber() //picoseconds to microseconds
	if(dueTime < Date.now()) {
		window.ERR = {title: "Hongbao Expired",
        	  content: "Sorry, but this hongbao was expired at "+timestamp2string(dueTime)};
        	window.AlertDlg = new Attention.Alert(window.ERR);
		return false;
	}

	const exhubContract = new ethers.Contract(ExHubAddress, ExHubABI, provider);
	var alreadyAccepted = await exhubContract.isReplay(hongbao.maker, hongbao.dueTime);
	//console.log("alreadyAccepted", alreadyAccepted);
	//console.log("dueTime", hongbao.dueTime);
	//const a = await exhubContract.makerNextRecentDueTime(hongbao.maker, hongbao.dueTime);
	//console.log("a", a);
	//const b = await exhubContract.makerRDTHeadTail(hongbao.maker);
	//console.log("b", b);
	if(alreadyAccepted) {
		window.ERR = {title: "Already Accepted",
        	  content: "Sorry, but you have accepted this hongbao before"}
        	window.AlertDlg = new Attention.Alert(window.ERR);
		return false;
	}

	window.HB = hongbao
}

async function getHongbao() {
	if(window.ERR) {
        	window.AlertDlg = new Attention.Alert(window.ERR);
		return false;
	}
	if(!window.HB) {
		return false;
	}
	const provider = new ethers.providers.Web3Provider(window.ethereum);
	const signer = provider.getSigner();
	const myAddr = await signer.getAddress();
	const exhubContract = new ethers.Contract(ExHubAddress, ExHubABI, provider).connect(signer);

	const twoPow80 = ethers.BigNumber.from(2).pow(80);
	const twoPow96 = ethers.BigNumber.from(2).pow(96);
	var coinsToTaker = ethers.BigNumber.from(HB.coinType).mul(twoPow96).add(HB.amount)
	var takerAddr_dueTime80_v8 = ethers.BigNumber.from(myAddr).mul(twoPow80).add(HB.dueTime)
	takerAddr_dueTime80_v8 = takerAddr_dueTime80_v8.mul(256).add(HB.v)
	const tx = await exhubContract.exchangeWithAgentSig("0x0", coinsToTaker, takerAddr_dueTime80_v8, HB.maker, HB.r, HB.s);
	const receipt = await tx.wait();
	console.log(receipt);
	return false;
}

window.onload = init;

document.onclick = function() {
	if(window.AlertDlg) window.AlertDlg.destroy();
}

</script>
<iframe id="srcIframe" src="" style="display: none" hidden></iframe>
</body>
</html>
